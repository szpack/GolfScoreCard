<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>é«˜å°”å¤«èµ›äº‹è§’æ ‡åŠ©æ‰‹ Â· Golf Overlay</title>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MASTERS-STYLE DESIGN TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  /* App shell */
  --bg:      #070c12;
  --panel:   #0c1420;
  --card:    #101926;
  --border:  rgba(255,255,255,0.07);
  --b2:      rgba(255,255,255,0.13);
  --txt:     rgba(255,255,255,0.90);
  --t2:      rgba(255,255,255,0.56);
  --t3:      rgba(255,255,255,0.32);
  --gold:    #C9A84C;
  --green:   #1a5c3c;  /* Masters green */
  --red:     #C0534A;
  --f: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  --r: 8px;

  /* â”€â”€ Overlay theme tokens (Masters palette) â”€â”€ */
  --ov-badge-from: #1a6040;
  --ov-badge-to:   #124530;
  --ov-dark-from:  #0d1822;
  --ov-dark-to:    #0a1218;
  --ov-gold:       #C9A84C;
  --ov-gold2:      #e2bf6a;
  --ov-div:        2px;
  --ov-radius:     10px;

  /* result */
  --rc-ace:    #F5C842;
  --rc-eagle:  #4A9EFF;
  --rc-birdie: #3FAE7C;
  --rc-par:    #A8B8C4;
  --rc-bogey:  #D4A244;
  --rc-dbl:    #D06A5E;
  --rc-worse:  #B84A42;
}
*,*::before,*::after { margin:0; padding:0; box-sizing:border-box; }
html { height:100%; -webkit-text-size-adjust:100%; }
body {
  background:var(--bg); color:var(--txt);
  font-family:var(--f); font-size:14px;
  height:100%; display:flex; flex-direction:column;
  overflow:hidden; -webkit-font-smoothing:antialiased;
}
button {
  font-family:var(--f); cursor:pointer; border:none; outline:none;
  -webkit-tap-highlight-color:transparent; touch-action:manipulation;
}
button:active { opacity:.78; transform:scale(.96); }
input,select {
  font-family:var(--f); outline:none;
  -webkit-tap-highlight-color:transparent; color:var(--txt);
}
input[type=number]{ -moz-appearance:textfield; }
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button { -webkit-appearance:none; }
input[type=range]  { accent-color:var(--gold); cursor:pointer; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   APP LAYOUT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app { display:flex; flex-direction:column; height:100%; max-height:100dvh; }

/* â”€â”€ Header bar â”€â”€ */
.hdr {
  background:var(--panel);
  border-bottom:2px solid var(--green);
  padding:0 16px;
  display:flex; align-items:center; justify-content:space-between;
  flex-shrink:0; gap:10px; min-height:44px;
  flex-wrap:wrap;
}
.hdr-brand {
  display:flex; flex-direction:column; gap:1px;
  padding:6px 0;
}
.hdr-title {
  font-size:14px; font-weight:700; letter-spacing:1.5px;
  color:#fff;
  white-space:nowrap;
}
.hdr-sub {
  font-size:9px; color:var(--t3); letter-spacing:1px;
}
.hdr-right { display:flex; align-items:center; gap:5px; flex-wrap:wrap; }

/* chip toolbar button */
.chip {
  height:28px; padding:0 11px; border-radius:5px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.04); color:var(--t3);
  font-size:10px; font-weight:700; letter-spacing:.8px;
  text-transform:uppercase; white-space:nowrap;
  transition:background .12s,color .12s;
}
.chip:hover  { background:rgba(255,255,255,.09); color:var(--txt); }
.chip.on     { background:rgba(201,168,76,.18); border-color:var(--gold); color:var(--gold); }
.chip.danger { border-color:rgba(192,83,74,.35); color:rgba(192,83,74,.8); }
.chip.danger:hover { background:rgba(192,83,74,.12); color:var(--red); }
.chip:active { transform:scale(.95); opacity:1; }
.bar-sep { width:1px; height:16px; background:var(--border); flex-shrink:0; }

/* â”€â”€ Preview area â”€â”€ */
.preview-area {
  flex:1; display:flex; align-items:center; justify-content:center;
  background:#040810; position:relative; overflow:hidden; min-height:0;
}
.canvas-wrap { position:relative; flex-shrink:0; cursor:default; }
#pcanvas     { display:block; }
#pcanvas.ov-hover { cursor:grab; }
#pcanvas.ov-drag  { cursor:grabbing; }
#pcanvas.bg-drag  { cursor:move; }

/* tap-to-upload hint */
.tap-hint {
  position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,.52); border:1px dashed rgba(255,255,255,.2);
  border-radius:7px; padding:5px 14px;
  font-size:10px; letter-spacing:1.5px; text-transform:uppercase;
  color:rgba(255,255,255,.3); pointer-events:none; white-space:nowrap;
}
.canvas-wrap.has-ref .tap-hint { display:none; }

/* â”€â”€ Settings drawer â”€â”€ */
.drawer {
  position:fixed; inset:0; z-index:200;
  pointer-events:none; visibility:hidden;
  transition:visibility 0s .26s;
}
.drawer.open { pointer-events:all; visibility:visible; transition:none; }
.dscrim {
  position:absolute; inset:0; background:rgba(0,0,0,.6);
  opacity:0; transition:opacity .26s;
}
.drawer.open .dscrim { opacity:1; }
.dpanel {
  position:absolute; right:0; top:0; bottom:0;
  width:min(360px,94vw); background:var(--panel);
  border-left:1px solid var(--border);
  display:flex; flex-direction:column;
  transform:translateX(100%);
  transition:transform .26s cubic-bezier(.4,0,.2,1);
  overflow:hidden;
}
.drawer.open .dpanel { transform:none; }
.dhdr {
  display:flex; align-items:center; justify-content:space-between;
  padding:13px 16px 12px; border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.dtitle { font-size:11px; font-weight:700; letter-spacing:2.5px; text-transform:uppercase; color:var(--gold); }
.dclose {
  width:30px; height:30px; border-radius:5px;
  background:rgba(255,255,255,.06); color:var(--t2);
  font-size:14px; display:flex; align-items:center; justify-content:center;
  border:1px solid var(--border);
}
.dbody {
  flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch;
  padding:14px 16px 24px; display:flex; flex-direction:column; gap:18px;
}
.ds { display:flex; flex-direction:column; gap:8px; }
.dslbl { font-size:8.5px; letter-spacing:2.5px; text-transform:uppercase; color:var(--t3); font-weight:600; }
.dsrow { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.dsdiv { height:1px; background:var(--border); margin:2px 0; }

/* â”€â”€ Control panel â”€â”€ */
.ctrl {
  flex-shrink:0; background:var(--panel);
  border-top:1px solid var(--border);
  overflow-y:auto; -webkit-overflow-scrolling:touch;
  max-height:50svh;
}
.csec {
  padding:10px 14px 11px;
  border-bottom:1px solid var(--border);
  display:flex; flex-direction:column; gap:8px;
}
.csec:last-child { border-bottom:none; }
.clbl { font-size:8px; letter-spacing:3px; text-transform:uppercase; color:var(--t3); font-weight:600; }

/* Player name input */
.player-in {
  flex:1; height:36px; padding:0 10px;
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--r); font-size:14px; font-weight:600;
  color:var(--txt); min-width:0;
}
.player-in:focus  { border-color:var(--gold); }
.player-in::placeholder { color:var(--t3); }

/* Segment / Par buttons */
.seg { display:flex; border-radius:var(--r); overflow:hidden; border:1px solid var(--border); background:var(--card); }
.seg-btn {
  flex:1; height:44px; background:transparent;
  border:none; color:rgba(255,255,255,.48);
  font-size:16px; font-weight:700;
  border-right:1px solid var(--border);
  transition:background .12s, color .12s;
}
.seg-btn:last-child { border-right:none; }
.seg-btn:hover { background:rgba(255,255,255,.08); color:var(--txt); }
.seg-btn:active { transform:none; opacity:1; background:rgba(255,255,255,.14); }
.seg-btn.on { background:var(--green); color:#fff; }

/* Spinner */
.spin { display:flex; align-items:center; gap:4px; }
.sp-btn {
  width:44px; height:44px; background:var(--card);
  border:1px solid var(--border); border-radius:var(--r);
  color:var(--txt); font-size:22px; font-weight:300;
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
}
.sp-btn:hover { background:rgba(255,255,255,.1); }
.sp-btn:active { transform:scale(.93); opacity:1; background:rgba(255,255,255,.15); }
.sp-val {
  width:58px; height:44px; background:var(--card);
  border:1px solid var(--border); border-radius:var(--r);
  text-align:center; font-size:22px; font-weight:800; min-width:0;
}
.sp-val:focus { border-color:var(--gold); }
.sp-unit { font-size:10px; color:var(--t3); letter-spacing:1px; white-space:nowrap; }

/* Shot type row */
.st-row { display:flex; gap:5px; flex-wrap:wrap; }
.st-btn {
  flex:1; min-width:68px; height:40px;
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--r); color:rgba(255,255,255,.45);
  font-size:10.5px; font-weight:700; letter-spacing:.7px; text-transform:uppercase;
  transition:all .12s;
}
.st-btn:hover { background:rgba(255,255,255,.09); color:var(--txt); }
.st-btn:active { transform:scale(.95); opacity:1; }
.st-btn.on-TEE      { background:rgba(255,255,255,.13); border-color:rgba(255,255,255,.4); color:#fff; }
.st-btn.on-APPROACH { background:rgba(74,158,255,.14); border-color:#4A9EFF; color:#4A9EFF; }
.st-btn.on-CHIP     { background:rgba(240,168,48,.14);  border-color:#F0A830; color:#F0A830; }
.st-btn.on-PUTT     { background:rgba(184,164,240,.14); border-color:#B8A4F0; color:#B8A4F0; }
.auto-tag {
  font-size:8px; padding:1px 6px; border-radius:5px;
  background:rgba(201,168,76,.13); border:1px solid rgba(201,168,76,.28);
  color:var(--gold); letter-spacing:.8px; font-weight:700;
}

/* Result buttons */
.res-row { display:flex; gap:4px; flex-wrap:wrap; }
.res-btn {
  flex:1; min-width:40px; height:34px; padding:0 5px;
  background:var(--card); border:1px solid var(--border);
  border-radius:var(--r); color:rgba(255,255,255,.38);
  font-size:10px; font-weight:700; letter-spacing:.5px; text-transform:uppercase;
  transition:all .12s;
}
.res-btn:hover { background:rgba(255,255,255,.09); color:var(--txt); }
.res-btn:active { transform:scale(.95); opacity:1; }
.res-btn.on-ace,.res-btn.on-eagle { background:rgba(245,200,66,.14);  border-color:var(--rc-ace);    color:var(--rc-ace); }
.res-btn.on-birdie { background:rgba(63,174,124,.14); border-color:var(--rc-birdie); color:var(--rc-birdie); }
.res-btn.on-par    { background:rgba(168,184,196,.1); border-color:var(--rc-par);    color:var(--rc-par); }
.res-btn.on-bogey  { background:rgba(212,162,68,.14); border-color:var(--rc-bogey);  color:var(--rc-bogey); }
.res-btn.on-double,.res-btn.on-worse { background:rgba(208,106,94,.13); border-color:var(--rc-dbl); color:var(--rc-dbl); }

/* Strokes override */
.strokes-in {
  width:54px; height:36px; background:var(--card);
  border:1px solid var(--border); border-radius:var(--r);
  text-align:center; font-size:18px; font-weight:800;
}
.strokes-in:focus { border-color:var(--gold); }

/* Action row */
.act-row { display:flex; gap:5px; align-items:stretch; flex-wrap:wrap; }
.btn-next {
  flex:2; min-width:120px; height:46px;
  background:var(--green); border-radius:var(--r); color:#fff;
  font-size:13px; font-weight:800; letter-spacing:2px; text-transform:uppercase;
  display:flex; align-items:center; justify-content:center; gap:6px;
  transition:background .12s;
}
.btn-next:hover { background:#1e6e46; }
.btn-next:active { opacity:.85; transform:scale(.97); }
.btn-newhole {
  flex:1; min-width:80px; height:46px;
  background:rgba(201,168,76,.1); border:1px solid rgba(201,168,76,.28);
  border-radius:var(--r); color:var(--gold);
  font-size:10px; font-weight:800; letter-spacing:1.5px; text-transform:uppercase;
  transition:background .12s;
}
.btn-newhole:hover { background:rgba(201,168,76,.2); }
.btn-newhole:active { opacity:.85; transform:scale(.97); }
.btn-icon {
  width:46px; height:46px; background:var(--card);
  border:1px solid var(--border); border-radius:var(--r);
  color:rgba(255,255,255,.45); font-size:16px;
  display:flex; align-items:center; justify-content:center;
  flex-shrink:0; transition:all .12s;
}
.btn-icon:hover { background:rgba(255,255,255,.1); color:var(--txt); }
.btn-icon:disabled { opacity:.2; cursor:default; }
.btn-icon:disabled:active { transform:none; opacity:.2; }

/* Export row */
.exp-row { display:flex; gap:5px; align-items:center; flex-wrap:wrap; }
.btn-export {
  height:42px; padding:0 18px;
  background:linear-gradient(135deg,#C9A84C,#E0BF60,#C9A84C);
  border-radius:var(--r); color:#1a1000;
  font-size:12px; font-weight:800; letter-spacing:2px; text-transform:uppercase;
  display:flex; align-items:center; gap:6px;
  box-shadow:0 2px 12px rgba(201,168,76,.22); white-space:nowrap;
  transition:box-shadow .15s;
}
.btn-export:hover { box-shadow:0 4px 20px rgba(201,168,76,.38); }
.btn-export:active { transform:scale(.97); opacity:.9; }
.btn-export:disabled { opacity:.4; cursor:default; }
.btn-export:disabled:active { transform:none; }
.btn-export svg { width:12px; height:12px; flex-shrink:0; }
.fmt-btn {
  height:32px; padding:0 11px; background:var(--card);
  border:1px solid var(--border); border-radius:5px;
  color:var(--t3); font-size:10px; font-weight:600; letter-spacing:.6px;
  transition:all .12s;
}
.fmt-btn:hover { background:rgba(255,255,255,.1); color:var(--txt); }
.fmt-btn:active { transform:scale(.95); opacity:1; }
.fmt-btn.on { background:rgba(201,168,76,.14); border-color:var(--gold); color:var(--gold); }
.res-sel {
  height:32px; padding:0 8px; background:var(--card);
  border:1px solid var(--border); border-radius:5px;
  font-size:11px; cursor:pointer;
}
.exp-fb { font-size:10px; letter-spacing:1.5px; color:var(--t3); opacity:0; transition:opacity .3s; white-space:nowrap; }
.exp-fb.on { opacity:1; }

/* Checkbox */
.chk {
  display:flex; align-items:center; gap:7px; cursor:pointer;
  padding:3px 5px; border-radius:4px; transition:background .12s;
  -webkit-tap-highlight-color:transparent; min-height:28px;
}
.chk:hover { background:rgba(255,255,255,.05); }
.chk-b {
  width:17px; height:17px; min-width:17px;
  border:1.5px solid rgba(255,255,255,.22); border-radius:3px;
  background:rgba(255,255,255,.04);
  display:flex; align-items:center; justify-content:center;
  transition:all .12s; pointer-events:none;
}
.chk-b svg { display:none; width:9px; height:9px; }
.chk.on .chk-b { background:var(--gold); border-color:var(--gold); }
.chk.on .chk-b svg { display:block; }
.chk.on .chk-lbl { color:rgba(255,255,255,.82); }
.chk-lbl { font-size:10px; letter-spacing:1.2px; text-transform:uppercase; color:var(--t3); transition:color .12s; white-space:nowrap; }

/* Scorecard mini strip */
.sc-strip {
  display:flex; gap:3px; overflow-x:auto; padding:2px 0;
  scrollbar-width:none;
}
.sc-strip::-webkit-scrollbar { display:none; }
.sc-hole {
  display:flex; flex-direction:column; align-items:center; gap:1px;
  min-width:26px; flex-shrink:0;
}
.sc-h-lbl { font-size:7px; color:var(--t3); letter-spacing:.5px; }
.sc-h-val {
  width:24px; height:22px; border-radius:3px;
  background:var(--card); border:1px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  font-size:10px; font-weight:700; color:var(--t2);
}
.sc-h-val.birdie { background:rgba(63,174,124,.22); border-color:var(--rc-birdie); color:var(--rc-birdie); }
.sc-h-val.eagle  { background:rgba(74,158,255,.2);  border-color:var(--rc-eagle);  color:var(--rc-eagle); }
.sc-h-val.bogey  { background:rgba(212,162,68,.18); border-color:var(--rc-bogey);  color:var(--rc-bogey); }
.sc-h-val.double,.sc-h-val.worse { background:rgba(208,106,94,.18); border-color:var(--rc-dbl); color:var(--rc-dbl); }
.sc-h-val.par    { background:rgba(168,184,196,.1); border-color:var(--rc-par);    color:var(--rc-par); }

/* position sliders */
.pos-row { display:flex; gap:4px; flex-wrap:wrap; }
.pos-btn {
  height:28px; padding:0 10px; background:var(--card);
  border:1px solid var(--border); border-radius:5px; color:var(--t3);
  font-size:10px; font-weight:700; letter-spacing:.4px; transition:all .12s;
}
.pos-btn:hover { background:rgba(255,255,255,.1); color:var(--txt); }
.pos-btn.on { background:rgba(201,168,76,.14); border-color:var(--gold); color:var(--gold); }
.pos-btn:active { transform:scale(.95); opacity:1; }

/* Status bar */
.sbar {
  display:flex; align-items:center; gap:8px; padding:5px 14px;
  background:var(--panel); border-top:1px solid var(--border);
  font-size:10px; letter-spacing:1px; color:var(--t3); flex-shrink:0;
}
.live { width:5px; height:5px; border-radius:50%; background:#22c55e; box-shadow:0 0 4px #22c55e; animation:lp 1.8s ease-in-out infinite; flex-shrink:0; }
@keyframes lp { 0%,100%{opacity:1}50%{opacity:.22} }

/* Scorecard totals */
.sc-totals {
  display:flex; gap:10px; align-items:center;
  padding:4px 8px; background:rgba(255,255,255,.04);
  border-radius:6px; border:1px solid var(--border);
}
.sc-tot-item { display:flex; flex-direction:column; align-items:center; gap:1px; }
.sc-tot-lbl { font-size:7px; letter-spacing:1px; text-transform:uppercase; color:var(--t3); }
.sc-tot-val { font-size:15px; font-weight:800; color:var(--txt); }
.sc-tot-val.under { color:var(--rc-birdie); }
.sc-tot-val.over  { color:var(--rc-bogey); }

/* Responsive */
@media(max-width:480px){
  .hdr { padding:0 10px; }
  .csec { padding:8px 10px 10px; }
}
</style>
</head>
<body>
<div class="app">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="hdr">
  <div class="hdr-brand">
    <div class="hdr-title">é«˜å°”å¤«èµ›äº‹è§’æ ‡åŠ©æ‰‹</div>
    <div class="hdr-sub">Golf Overlay Â· szpack@qq.com</div>
  </div>
  <div class="hdr-right">
    <div style="display:flex;gap:3px">
      <button class="chip on" id="asp169" onclick="setAsp('169')">16:9</button>
      <button class="chip"    id="asp916" onclick="setAsp('916')">9:16</button>
      <button class="chip"    id="asp11"  onclick="setAsp('11')">1:1</button>
    </div>
    <div class="bar-sep"></div>
    <button class="chip" id="btnSafe" onclick="toggleSafe()">Safe Zone</button>
    <div class="bar-sep"></div>
    <button class="chip" onclick="openDrawer()">âš™ è®¾ç½®</button>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PREVIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="preview-area" id="previewArea">
  <div class="canvas-wrap" id="canvasWrap">
    <canvas id="pcanvas"></canvas>
    <div class="tap-hint" id="tapHint">ç‚¹å‡»ç©ºç™½å¤„æ·»åŠ å‚è€ƒèƒŒæ™¯å›¾</div>
  </div>
</div>
<input type="file" id="refIn" accept="image/*" style="display:none" onchange="loadRef(this)">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS DRAWER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="drawer" id="drawer">
  <div class="dscrim" onclick="closeDrawer()"></div>
  <div class="dpanel">
    <div class="dhdr">
      <span class="dtitle">âš™ è®¾ç½® Settings</span>
      <button class="dclose" onclick="closeDrawer()">âœ•</button>
    </div>
    <div class="dbody">

      <!-- Position -->
      <div class="ds">
        <div class="dslbl">Overlay ä½ç½®</div>
        <div class="pos-row" id="posBtns">
          <button class="pos-btn on" data-pos="TR" onclick="setPos('TR')">â†— å³ä¸Š</button>
          <button class="pos-btn"    data-pos="TL" onclick="setPos('TL')">â†– å·¦ä¸Š</button>
          <button class="pos-btn"    data-pos="BL" onclick="setPos('BL')">â†™ å·¦ä¸‹</button>
          <button class="pos-btn"    data-pos="BR" onclick="setPos('BR')">â†˜ å³ä¸‹</button>
          <button class="pos-btn"    data-pos="C"  onclick="setPos('C')">âŠ™ å±…ä¸­</button>
        </div>
        <div class="dsrow">
          <span style="font-size:10px;color:var(--t3)">Inset (px/1080p)</span>
          <input style="width:54px;height:28px;background:var(--card);border:1px solid var(--border);border-radius:5px;text-align:center;font-size:13px;font-weight:700"
            type="number" id="insetIn" min="0" max="240" value="64" oninput="setInset(this.value)">
        </div>
        <div style="font-size:9px;color:var(--t3)">å¯åœ¨é¢„è§ˆåŒºæ‹–æ‹½ Overlay å¾®è°ƒä½ç½®</div>
      </div>
      <div class="dsdiv"></div>

      <!-- Overlay size -->
      <div class="ds">
        <div class="dslbl">è§’æ ‡å¤§å°</div>
        <div class="dsrow">
          <button class="chip" id="scSm" onclick="setOvSc(.78,'scSm')">å° S</button>
          <button class="chip on" id="scMd" onclick="setOvSc(1.0,'scMd')">ä¸­ M</button>
          <button class="chip" id="scLg" onclick="setOvSc(1.25,'scLg')">å¤§ L</button>
        </div>
      </div>
      <div class="dsdiv"></div>

      <!-- Ref background -->
      <div class="ds">
        <div class="dslbl">å‚è€ƒèƒŒæ™¯å›¾ï¼ˆä»…é¢„è§ˆç”¨ï¼‰</div>
        <div class="dsrow">
          <button class="chip" onclick="document.getElementById('refIn').click()">ğŸ“· é€‰æ‹©å›¾ç‰‡</button>
          <button class="chip danger" id="btnClrRef" style="display:none" onclick="clearRef()">âœ• æ¸…é™¤</button>
        </div>
        <div id="refSettings" style="display:none;flex-direction:column;gap:10px">
          <div class="dsrow">
            <span style="font-size:10px;color:var(--t3);min-width:44px">é€æ˜åº¦</span>
            <input type="range" id="refOpSlider" min="0" max="100" value="50" oninput="setRefOp(this.value)" style="flex:1;min-width:80px">
            <span style="font-size:10px;color:var(--t3);min-width:30px" id="refOpVal">50%</span>
          </div>
          <div class="dsrow">
            <button class="chip" id="btnRefVis" onclick="toggleRefVis()">Hide</button>
            <button class="chip" onclick="resetRef()">Reset</button>
          </div>
        </div>
      </div>
      <div class="dsdiv"></div>

      <!-- Display options -->
      <div class="ds">
        <div class="dslbl">æ˜¾ç¤ºé€‰é¡¹ Display Options</div>
        <div class="chk on" id="chkYards"   onclick="tog('showYards')">
          <span class="chk-b"><svg viewBox="0 0 9 7" fill="none" stroke="#000" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1,3.5 3.5,6 8,1"/></svg></span>
          <span class="chk-lbl">è·ç¦» To Pin (YDS)</span>
        </div>
        <div class="chk on" id="chkType"    onclick="tog('showType')">
          <span class="chk-b"><svg viewBox="0 0 9 7" fill="none" stroke="#000" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1,3.5 3.5,6 8,1"/></svg></span>
          <span class="chk-lbl">å‡»çƒç±»å‹ Shot Type</span>
        </div>
        <div class="chk on" id="chkPlayer"  onclick="tog('showPlayer')">
          <span class="chk-b"><svg viewBox="0 0 9 7" fill="none" stroke="#000" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1,3.5 3.5,6 8,1"/></svg></span>
          <span class="chk-lbl">çƒå‘˜å§“å Player Name</span>
        </div>
        <div class="chk" id="chkTotal"     onclick="tog('showTotal')">
          <span class="chk-b"><svg viewBox="0 0 9 7" fill="none" stroke="#000" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1,3.5 3.5,6 8,1"/></svg></span>
          <span class="chk-lbl">æœ¬åœºæ€»åˆ† Round Score</span>
        </div>
        <div id="totalModeRow" style="display:none;flex-direction:column;gap:6px">
          <div class="dslbl" style="margin-top:2px">æ€»åˆ†æ˜¾ç¤ºæ¨¡å¼</div>
          <div class="dsrow">
            <button class="chip on" id="tmGross" onclick="setTotalMode('gross')">æ€»æ† Gross</button>
            <button class="chip"    id="tmPar"   onclick="setTotalMode('par')">æ†å·® To Par</button>
          </div>
        </div>
      </div>
      <div class="dsdiv"></div>

      <!-- Unit -->
      <div class="ds">
        <div class="dslbl">è·ç¦»å•ä½</div>
        <div class="dsrow">
          <button class="chip on" id="unitYds" onclick="setUnit('YDS')">ç  YDS</button>
          <button class="chip"    id="unitM"   onclick="setUnit('M')">ç±³ M</button>
        </div>
      </div>
      <div class="dsdiv"></div>

      <!-- Round management -->
      <div class="ds">
        <div class="dslbl">æœ¬è½®ç®¡ç†</div>
        <button class="chip danger" onclick="confirmReset()">ğŸ—‘ æ¸…ç©ºæœ¬è½® Reset Round</button>
      </div>
      <div class="dsdiv"></div>

      <!-- Keyboard -->
      <div class="ds">
        <div class="dslbl">é”®ç›˜å¿«æ·é”®</div>
        <div style="font-size:10px;color:var(--t3);line-height:2">
          N / â†’ &nbsp;&nbsp;ä¸‹ä¸€æ† Next Shot<br>
          U / Ctrl+Z &nbsp;&nbsp;æ’¤é”€ Undo Shot<br>
          H &nbsp;&nbsp;æ–°æ´ New Hole<br>
          B / P / G &nbsp;&nbsp;Birdie / Par / Bogey<br>
          Enter &nbsp;&nbsp;å¯¼å‡º Export PNG
        </div>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONTROLS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="ctrl" id="ctrl">

  <!-- Player + Hole + Par row -->
  <div class="csec">
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start">

      <!-- Player name -->
      <div style="display:flex;flex-direction:column;gap:5px;flex:2;min-width:140px">
        <div class="clbl">çƒå‘˜å§“å Player</div>
        <input class="player-in" id="inPlayer" type="text" placeholder="e.g. Rory McIlroy"
          oninput="onPlayerInput(this.value)">
      </div>

      <!-- Hole -->
      <div style="display:flex;flex-direction:column;gap:5px">
        <div class="clbl">æ´å· Hole</div>
        <div class="spin">
          <button class="sp-btn" onclick="adj('holeNumber',-1)">âˆ’</button>
          <input class="sp-val" id="inHole" type="number" min="1" max="18" value="1" oninput="inp('holeNumber',this.value,1,18)">
          <button class="sp-btn" onclick="adj('holeNumber',1)">+</button>
        </div>
      </div>

      <!-- Par -->
      <div style="display:flex;flex-direction:column;gap:5px">
        <div class="clbl">æ ‡å‡†æ† Par</div>
        <div class="seg">
          <button class="seg-btn" data-p="3" onclick="setPar(3)">3</button>
          <button class="seg-btn on" data-p="4" onclick="setPar(4)">4</button>
          <button class="seg-btn" data-p="5" onclick="setPar(5)">5</button>
        </div>
      </div>

    </div>
  </div>

  <!-- Yards + Shot type -->
  <div class="csec">
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start">

      <!-- Yards -->
      <div style="display:flex;flex-direction:column;gap:5px">
        <div class="clbl" id="yardsLbl">è·ç¦» Yards (To Pin)</div>
        <div class="spin">
          <button class="sp-btn" onpointerdown="startAdj('yards',-5)" onpointerup="stopAdj()" onpointerleave="stopAdj()">âˆ’</button>
          <input class="sp-val" id="inYards" type="number" min="0" max="700" value="385" oninput="inp('yards',this.value,0,700)" style="width:64px">
          <button class="sp-btn" onpointerdown="startAdj('yards',5)" onpointerup="stopAdj()" onpointerleave="stopAdj()">+</button>
          <span class="sp-unit" id="unitTag">YDS</span>
        </div>
      </div>

      <!-- Shot type -->
      <div style="display:flex;flex-direction:column;gap:5px;flex:1;min-width:200px">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="clbl">å‡»çƒç±»å‹ Shot Type</div>
          <span class="auto-tag" id="autoTag">AUTO</span>
        </div>
        <div class="st-row">
          <button class="st-btn" data-st="TEE"      onclick="setST('TEE')">Tee</button>
          <button class="st-btn" data-st="APPROACH" onclick="setST('APPROACH')">Approach</button>
          <button class="st-btn" data-st="CHIP"     onclick="setST('CHIP')">Chip</button>
          <button class="st-btn" data-st="PUTT"     onclick="setST('PUTT')">Putt</button>
        </div>
      </div>

    </div>
  </div>

  <!-- Result + Strokes -->
  <div class="csec">
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <div class="clbl" style="flex:0 0 auto">æœ¬æ´ç»“æœï¼ˆå®Œæ´åé€‰ï¼‰</div>
      <div style="display:flex;align-items:center;gap:6px;flex:0 0 auto">
        <span style="font-size:9px;color:var(--t3)">å®é™…æ†æ•°</span>
        <input class="strokes-in" id="inStrokes" type="number" min="1" max="20" value="4" oninput="onStrokesInput(this.value)">
      </div>
    </div>
    <div class="res-row">
      <button class="res-btn" data-r="ace"    onclick="setRes('ace')">â­ Ace</button>
      <button class="res-btn" data-r="eagle"  onclick="setRes('eagle')">Eagle</button>
      <button class="res-btn" data-r="birdie" onclick="setRes('birdie')">Birdie</button>
      <button class="res-btn" data-r="par"    onclick="setRes('par')">Par</button>
      <button class="res-btn" data-r="bogey"  onclick="setRes('bogey')">Bogey</button>
      <button class="res-btn" data-r="double" onclick="setRes('double')">Dbl</button>
      <button class="res-btn" data-r="worse"  onclick="setRes('worse')">+3</button>
    </div>
  </div>

  <!-- Scorecard strip -->
  <div class="csec" id="scSection">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px">
      <div class="clbl">è®¡åˆ†å¡é¢„è§ˆ</div>
      <div class="sc-totals" id="scTotals">
        <div class="sc-tot-item">
          <div class="sc-tot-lbl">GROSS</div>
          <div class="sc-tot-val" id="totGross">â€”</div>
        </div>
        <div style="width:1px;height:20px;background:var(--border)"></div>
        <div class="sc-tot-item">
          <div class="sc-tot-lbl">TO PAR</div>
          <div class="sc-tot-val" id="totPar">â€”</div>
        </div>
      </div>
    </div>
    <div class="sc-strip" id="scStrip"></div>
  </div>

  <!-- Actions + Export -->
  <div class="csec">
    <div class="act-row">
      <button class="btn-next" onclick="nextShot()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M5 12h14M13 6l6 6-6 6"/></svg>
        ä¸‹ä¸€æ† NEXT SHOT
      </button>
      <button class="btn-newhole" onclick="newHole()">â›³ æ–°æ´ NEW</button>
      <button class="btn-icon" id="btnUndoShot" onclick="undoShot()" title="ä¸Šä¸€æ† Prev Shot" disabled>â†©</button>
      <button class="btn-icon" id="btnUndoHole" onclick="undoHole()" title="ä¸Šä¸€æ´ Prev Hole">âŒ«</button>
    </div>
    <div class="exp-row">
      <button class="btn-export" id="btnExp" onclick="doExport()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        å¯¼å‡º EXPORT PNG
      </button>
      <button class="fmt-btn on" id="fmtT" onclick="setFmt('transparent')">é€æ˜</button>
      <button class="fmt-btn"    id="fmtB" onclick="setFmt('black')">é»‘åº•</button>
      <select class="res-sel" id="resSel">
        <option value="2160">4K (2160p)</option>
        <option value="1080">1080p</option>
        <option value="1440">1440p</option>
      </select>
      <span class="exp-fb" id="expFb"></span>
    </div>
  </div>

</div><!-- /ctrl -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="sbar">
  <div class="live"></div>
  <span id="sbText">Hole 1 Â· Par 4 Â· Shot 1</span>
  <span style="margin-left:auto;font-size:9px;opacity:.35;white-space:nowrap">N=ä¸‹ä¸€æ† Â· U=æ’¤é”€ Â· B/P/G=æˆç»© Â· Enter=å¯¼å‡º</span>
  <span id="sbLS" style="font-size:9px;opacity:.35;margin-left:8px">LSâœ“</span>
</div>

</div><!-- /app -->

<script>
'use strict';
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCHEMA VERSION â€” increment when data shape changes
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SCHEMA_VER = 3;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS (mirror CSS, used in Canvas renderer)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TH = {
  // badge
  badgeFrom: '#1a6040', badgeTo: '#124530',
  badgeW: 100,          // logical px at scale=1 (1080p)
  // divider
  divW: 2, divColor: '#C9A84C',
  // info panel
  infoFrom: '#0d1822', infoTo: '#0a1218',
  // card dimensions
  cardH:   120,         // total card height (logical)
  playerH:  28,         // player name strip height
  topH:     90,         // main info row
  botH:     30,         // shot pips row
  // radius
  r: 10,
  // fonts (system stack)
  f: 'ui-sans-serif,system-ui,-apple-system,"SF Pro Display","Segoe UI",Roboto,Helvetica,Arial,sans-serif',
  // colours
  gold: '#C9A84C', gold2: '#E0BF60',
  rCol: {
    ace:'#F5C842', eagle:'#4A9EFF', birdie:'#3FAE7C',
    par:'#A8B8C4', bogey:'#D4A244', double:'#D06A5E', worse:'#B84A42'
  },
  stCol: {
    TEE:'rgba(255,255,255,.86)', APPROACH:'#4A9EFF', CHIP:'#F0A830', PUTT:'#B8A4F0'
  },
  stLbl: { TEE:'TEE SHOT', APPROACH:'APPROACH', CHIP:'CHIP', PUTT:'PUTTING' },
  resLbl: { ace:'HOLE IN ONE', eagle:'EAGLE', birdie:'BIRDIE', par:'PAR', bogey:'BOGEY', double:'DBL BOGEY', worse:'+3' },
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA MODEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PAR_DEF = { 3:165, 4:385, 5:520 };
const ASP_RATIO = { '169':16/9, '916':9/16, '11':1 };

function inferType(par, shot) {
  if (shot === 1) return 'TEE';
  if (shot - par >= 0) return 'PUTT';
  if (par === 3) return 'PUTT';
  if (par === 4) return shot === 2 ? 'APPROACH' : 'PUTT';
  if (par === 5) { if(shot===2) return 'APPROACH'; if(shot===3) return 'CHIP'; return 'PUTT'; }
  return 'TEE';
}

function hexRgb(hex) {
  return `${parseInt(hex.slice(1,3),16)},${parseInt(hex.slice(3,5),16)},${parseInt(hex.slice(5,7),16)}`;
}

// Default state
const DFLT = {
  // current shot
  holeNumber:1, par:4, yards:385, holeYards:385,
  shotIndex:1, shotType:'TEE', manualType:false, holeResult:null,
  strokes: 4,
  // player
  playerName:'',
  // display options
  showYards:true, showType:true, showPlayer:true, showTotal:false,
  totalMode:'gross',   // 'gross' | 'par'
  unit:'YDS',
  // position
  position:'TR', inset:64, customX:null, customY:null,
  ovScale:1.0,
  // UI prefs
  safeOn:false, aspect:'169', fmt:'transparent',
  // round data
  round: [],  // [{holeNumber, par, strokes, result}]
};

let S = { ...DFLT, round:[] };

// Undo stacks
let shotStack = [];
let holeStack = [];

/* â”€â”€ Ref image â”€â”€ */
let refImg=null, refVisible=true, refOpacity=0.5, refScaleMod=1;
let refOffX=0, refOffY=0;

/* â”€â”€ Long-press repeat for yards â”€â”€ */
let _adjTimer=null, _adjFast=null;
function startAdj(key,d) {
  adj(key,d);
  _adjTimer = setTimeout(()=>{
    _adjFast = setInterval(()=>adj(key,d), 80);
  }, 420);
}
function stopAdj() {
  clearTimeout(_adjTimer); clearInterval(_adjFast);
  _adjTimer=null; _adjFast=null;
}

/* â”€â”€ Persistence â”€â”€ */
let _saveT=null;
function queueSave(){
  clearTimeout(_saveT);
  _saveT = setTimeout(persistState, 300);
}
function persistState(){
  try {
    const d={...S, _v:SCHEMA_VER}; delete d.exportIncRef;
    localStorage.setItem('golf_masters', JSON.stringify(d));
    el('sbLS').textContent='LSâœ“';
  } catch(e){ el('sbLS').textContent='LSâœ—'; }
}
function loadState(){
  try {
    const raw=localStorage.getItem('golf_masters');
    if(raw){
      const d=JSON.parse(raw);
      if(d._v===SCHEMA_VER) S={...DFLT, ...d, round:d.round||[]};
      // else: schema changed, use defaults
    }
  } catch(e){}
}

/* â”€â”€ Commit â”€â”€ */
function commit(partial){
  shotStack.push({...S, round:[...S.round.map(h=>({...h}))]});
  if(shotStack.length>80) shotStack.shift();
  Object.assign(S, partial);
  queueSave(); render();
}

/* â”€â”€ Round helpers â”€â”€ */
function roundTotals(){
  const r = S.round;
  const gross = r.reduce((s,h)=>s+(h.strokes||h.par),0);
  const par   = r.reduce((s,h)=>s+(h.strokes||h.par)-h.par,0);
  return { gross, par };
}

/* â”€â”€ Actions â”€â”€ */
function undoShot(){
  if(!shotStack.length) return;
  S=shotStack.pop(); queueSave(); render();
}
function undoHole(){
  if(!holeStack.length) return;
  S=holeStack.pop(); shotStack=[]; queueSave(); render();
}
function newHole(){
  // Save current hole to round
  const hi = S.round.findIndex(h=>h.holeNumber===S.holeNumber);
  const rec = { holeNumber:S.holeNumber, par:S.par, strokes:S.strokes, result:S.holeResult };
  if(hi>=0) S.round[hi]=rec; else S.round.push(rec);

  holeStack.push({...S, round:[...S.round.map(h=>({...h}))]});
  if(holeStack.length>20) holeStack.shift();
  shotStack=[];
  const next=S.holeNumber>=18?1:S.holeNumber+1;
  S={
    ...DFLT, round:[...S.round.map(h=>({...h}))],
    holeNumber:next, par:S.par, yards:PAR_DEF[S.par], holeYards:PAR_DEF[S.par],
    strokes:S.par,
    playerName:S.playerName, unit:S.unit,
    position:S.position, inset:S.inset, customX:S.customX, customY:S.customY,
    ovScale:S.ovScale, safeOn:S.safeOn, aspect:S.aspect, fmt:S.fmt,
    showYards:S.showYards, showType:S.showType, showPlayer:S.showPlayer,
    showTotal:S.showTotal, totalMode:S.totalMode,
  };
  queueSave(); render();
}
function nextShot(){
  const n=S.shotIndex+1;
  commit({shotIndex:n, shotType:S.manualType?S.shotType:inferType(S.par,n), manualType:false});
}
function confirmReset(){
  if(confirm('ç¡®è®¤æ¸…ç©ºæœ¬è½®æ‰€æœ‰æ•°æ®ï¼Ÿ\nReset all round data?')){
    S={...DFLT, round:[]}; shotStack=[]; holeStack=[];
    queueSave(); render();
  }
}

/* â”€â”€ Control handlers â”€â”€ */
function adj(key,d){
  const rngs={holeNumber:[1,18],yards:[0,700]};
  const [mn,mx]=rngs[key]||[0,9999];
  commit({[key]:Math.max(mn,Math.min(mx,(S[key]||0)+d))});
}
function inp(key,v,mn,mx){
  const n=parseInt(v); if(!isNaN(n)) commit({[key]:Math.max(mn,Math.min(mx,n))});
}
function tog(key){ commit({[key]:!S[key]}); }
function setPar(p){ commit({par:p, yards:PAR_DEF[p], holeYards:PAR_DEF[p], strokes:p}); }
function setST(t) { commit({shotType:t, manualType:true}); }
function setRes(r){
  // Auto-calc strokes from result
  const delta={ace:-S.par, eagle:-2, birdie:-1, par:0, bogey:1, double:2, worse:3};
  const strokes=Math.max(1, S.par + (delta[r]||0));
  commit({holeResult:S.holeResult===r?null:r, strokes:r===null?S.par:strokes});
}
function setAsp(a){ commit({aspect:a}); }
function setUnit(u){ commit({unit:u}); }
function setPos(p){ commit({position:p, customX:null, customY:null}); }
function setInset(v){ commit({inset:Math.max(0,Math.min(240,parseInt(v)||0))}); }
function setFmt(f){ commit({fmt:f}); }
function toggleSafe(){ commit({safeOn:!S.safeOn}); }
function setOvSc(s,btnId){
  commit({ovScale:s});
  ['scSm','scMd','scLg'].forEach(id=>el(id).classList.toggle('on',id===btnId));
}
function setTotalMode(m){ commit({totalMode:m}); }
function onPlayerInput(v){ commit({playerName:v}); }
function onStrokesInput(v){ const n=parseInt(v); if(!isNaN(n)&&n>=1&&n<=20) commit({strokes:n}); }

/* â”€â”€ Ref image â”€â”€ */
function loadRef(input){
  const file=input.files[0]; if(!file) return;
  if(refImg&&refImg._url) URL.revokeObjectURL(refImg._url);
  const url=URL.createObjectURL(file);
  const img=new Image();
  img.onload=()=>{
    refImg=img; refImg._url=url;
    refOffX=0; refOffY=0; refScaleMod=1; refVisible=true;
    el('refSettings').style.display='flex';
    el('btnClrRef').style.display='';
    el('canvasWrap').classList.add('has-ref');
    el('btnRefVis').textContent='Hide';
    render();
  };
  img.src=url; input.value='';
}
function clearRef(){
  if(refImg&&refImg._url) URL.revokeObjectURL(refImg._url);
  refImg=null;
  el('refSettings').style.display='none';
  el('btnClrRef').style.display='none';
  el('canvasWrap').classList.remove('has-ref');
  render();
}
function setRefOp(v){ refOpacity=parseFloat(v)/100; el('refOpVal').textContent=v+'%'; render(); }
function setRefSc(v){ refScaleMod=parseFloat(v)/100; render(); }
function resetRef(){ refOffX=0; refOffY=0; refScaleMod=1; render(); }
function toggleRefVis(){ refVisible=!refVisible; el('btnRefVis').textContent=refVisible?'Hide':'Show'; render(); }

/* â”€â”€ Drawer â”€â”€ */
function openDrawer()  { el('drawer').classList.add('open'); }
function closeDrawer() { el('drawer').classList.remove('open'); }

/* â”€â”€ Utils â”€â”€ */
function el(id){ return document.getElementById(id); }
function pad(n){ return String(n).padStart(2,'0'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDERER â€” single drawOverlay() used by preview + export
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// Natural (logical) card dimensions at 1080p scale=1
// Card total width depends on content; height=cardH (or cardH+playerH if player shown)
const OVW        = 780;  // card width at scale=1
const OV_BADGE_W = TH.badgeW;
const OV_DIV_W   = TH.divW;
const OV_INFO_W  = OVW - OV_BADGE_W - OV_DIV_W;
const OV_TOP_H   = TH.topH;
const OV_BOT_H   = TH.botH;
const OV_CARD_H  = OV_TOP_H + OV_BOT_H;   // main card
const OV_PLAYER_H= TH.playerH;

function totalOvH(showPlayer){ return OV_CARD_H + (showPlayer ? OV_PLAYER_H : 0); }

/* â”€â”€ rounded rect helpers â”€â”€ */
function rrect(ctx,x,y,w,h,r){
  r=Math.min(r,Math.min(w,h)/2);
  ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath();
}
function rrectTL(ctx,x,y,w,h,r){ // top-left rounded corners only
  r=Math.min(r,Math.min(w,h)/2);
  ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.lineTo(x+w,y); ctx.lineTo(x+w,y+h);
  ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath();
}
function rrectTR(ctx,x,y,w,h,r){ // top-right & bottom-right rounded
  r=Math.min(r,Math.min(w,h)/2);
  ctx.beginPath();
  ctx.moveTo(x,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x,y+h); ctx.closePath();
}
function rrectAll4(ctx,x,y,w,h,r,tl,tr,br,bl){
  // selective corner rounding
  ctx.beginPath();
  ctx.moveTo(x+(tl?r:0),y);
  ctx.lineTo(x+w-(tr?r:0),y); if(tr) ctx.quadraticCurveTo(x+w,y,x+w,y+r); else ctx.lineTo(x+w,y);
  ctx.lineTo(x+w,y+h-(br?r:0)); if(br) ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); else ctx.lineTo(x+w,y+h);
  ctx.lineTo(x+(bl?r:0),y+h); if(bl) ctx.quadraticCurveTo(x,y+h,x,y+h-r); else ctx.lineTo(x,y+h);
  ctx.lineTo(x,y+(tl?r:0)); if(tl) ctx.quadraticCurveTo(x,y,x+r,y); else ctx.lineTo(x,y);
  ctx.closePath();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   drawOverlay(ctx, {scale, ox, oy, forExport})
   Renders the complete overlay at position (ox,oy) with given scale.
   All dimensions = logical_px * scale.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function drawOverlay(ctx, cfg){
  const { scale:sc, ox, oy, forExport } = cfg;
  const sp = S.showPlayer && S.playerName;
  const totalH = totalOvH(sp) * sc;
  const cardY  = oy + (sp ? OV_PLAYER_H*sc : 0);

  const W  = OVW * sc;
  const cH = OV_CARD_H * sc;
  const bW = OV_BADGE_W * sc;
  const dW = OV_DIV_W   * sc;
  const iW = OV_INFO_W  * sc;
  const iX = ox + bW + dW;
  const tH = OV_TOP_H * sc;
  const bH = OV_BOT_H * sc;
  const R  = TH.r * sc;

  /* â”€â”€ Drop shadow (preview only) â”€â”€ */
  if(!forExport){
    ctx.save();
    ctx.shadowColor='rgba(0,0,0,0.65)'; ctx.shadowBlur=28*sc; ctx.shadowOffsetY=6*sc;
    ctx.fillStyle='rgba(0,0,0,0.001)';
    rrect(ctx,ox,oy,W,totalH,R); ctx.fill();
    ctx.restore();
  }

  /* â”€â”€ Player name strip (optional) â”€â”€ */
  if(sp){
    const pH=OV_PLAYER_H*sc;
    // strip background
    ctx.save();
    rrectAll4(ctx,ox,oy,W,pH,R, true,true,false,false);
    ctx.fillStyle='rgba(10,14,20,.9)'; ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.07)'; ctx.lineWidth=1*sc; ctx.stroke();
    // name text
    ctx.fillStyle='rgba(255,255,255,.88)';
    ctx.font=`600 ${12*sc}px ${TH.f}`; ctx.letterSpacing=(0.5*sc)+'px';
    ctx.textAlign='left'; ctx.textBaseline='middle';
    ctx.fillText(S.playerName.toUpperCase(), ox+14*sc, oy+pH/2);
    ctx.restore();

    // If total score shown, right side of player strip
    if(S.showTotal && S.round.length>0){
      const {gross,par} = roundTotals();
      const tStr = S.totalMode==='gross' ? String(gross) : (par===0?'E': par>0?'+'+par:String(par));
      const tCol = par<0 ? TH.rCol.birdie : par>0 ? TH.rCol.bogey : TH.rCol.par;
      ctx.save();
      ctx.textAlign='right'; ctx.textBaseline='middle';
      ctx.fillStyle=tCol;
      ctx.font=`800 ${13*sc}px ${TH.f}`; ctx.letterSpacing='0px';
      ctx.fillText(tStr, ox+W-12*sc, oy+pH/2);
      ctx.fillStyle='rgba(255,255,255,.32)';
      ctx.font=`500 ${9*sc}px ${TH.f}`; ctx.letterSpacing=(1*sc)+'px';
      ctx.fillText(S.totalMode==='gross'?'GROSS':'TO PAR', ox+W-12*sc-ctx.measureText(tStr).width-8*sc, oy+pH/2);
      ctx.restore();
    }
  }

  /* â”€â”€ Badge (green left block) â”€â”€ */
  ctx.save();
  rrectAll4(ctx,ox,cardY,bW,cH,R, !sp,false,false,true);
  const gB=ctx.createLinearGradient(ox,cardY,ox,cardY+cH);
  gB.addColorStop(0,TH.badgeFrom); gB.addColorStop(1,TH.badgeTo);
  ctx.fillStyle=gB; ctx.fill();
  // inner border
  ctx.strokeStyle='rgba(255,255,255,0.09)'; ctx.lineWidth=1*sc;
  rrectAll4(ctx,ox+.5*sc,cardY+.5*sc,bW-.5*sc,cH-1*sc,R, !sp,false,false,true); ctx.stroke();
  ctx.restore();

  // HOLE label
  ctx.fillStyle='rgba(255,255,255,.42)';
  ctx.font=`500 ${8.5*sc}px ${TH.f}`; ctx.letterSpacing=(2*sc)+'px';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('HOLE', ox+bW/2, cardY+18*sc);

  // Hole number (large)
  ctx.fillStyle='rgba(255,255,255,.97)';
  ctx.font=`800 ${56*sc}px ${TH.f}`; ctx.letterSpacing=(-1*sc)+'px';
  ctx.fillText(String(S.holeNumber), ox+bW/2, cardY+58*sc);

  // PAR x
  ctx.fillStyle=TH.gold;
  ctx.font=`600 ${12*sc}px ${TH.f}`; ctx.letterSpacing=(1.5*sc)+'px';
  ctx.fillText('PAR '+S.par, ox+bW/2, cardY+88*sc);

  /* â”€â”€ Gold divider â”€â”€ */
  const gD=ctx.createLinearGradient(ox+bW,cardY,ox+bW,cardY+cH);
  gD.addColorStop(0,'rgba(201,168,76,.75)'); gD.addColorStop(.5,TH.gold); gD.addColorStop(1,'rgba(201,168,76,.45)');
  ctx.fillStyle=gD;
  ctx.fillRect(ox+bW,cardY,dW,cH);

  /* â”€â”€ Info panel (dark right block) â”€â”€ */
  ctx.save();
  rrectAll4(ctx,iX,cardY,iW,cH,R, false,!sp,true,false);
  const gI=ctx.createLinearGradient(iX,cardY,iX,cardY+cH);
  gI.addColorStop(0,TH.infoFrom); gI.addColorStop(1,TH.infoTo);
  ctx.fillStyle=gI; ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,0.07)'; ctx.lineWidth=1*sc;
  rrectAll4(ctx,iX+.5*sc,cardY+.5*sc,iW-1*sc,cH-1*sc,R,false,!sp,true,false); ctx.stroke();
  ctx.restore();

  // Top highlight strip
  const gHL=ctx.createLinearGradient(iX,cardY,iX+iW,cardY);
  gHL.addColorStop(0,'rgba(255,255,255,0)'); gHL.addColorStop(.4,'rgba(255,255,255,.04)'); gHL.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle=gHL; ctx.fillRect(iX,cardY,iW,2*sc);

  // top/bottom separator
  ctx.fillStyle='rgba(255,255,255,.07)'; ctx.fillRect(iX,cardY+tH,iW,1*sc);
  ctx.fillStyle='rgba(0,0,0,.2)';        ctx.fillRect(iX,cardY+tH+1*sc,iW,bH-1*sc);

  const pX=iX+16*sc;

  /* â”€â”€ Yards (primary) â”€â”€ */
  if(S.showYards){
    const disp=S.unit==='M'?Math.round(S.yards*.9144):S.yards;
    const ys=String(disp);
    const yl=S.shotIndex===1?'HOLE':'TO PIN';

    ctx.save();
    ctx.textAlign='left';
    // Label
    ctx.fillStyle='rgba(255,255,255,.38)';
    ctx.font=`500 ${9.5*sc}px ${TH.f}`; ctx.letterSpacing=(2*sc)+'px';
    ctx.textBaseline='top';
    ctx.fillText(yl, pX, cardY+13*sc);

    // Big number
    ctx.fillStyle='rgba(255,255,255,.95)';
    ctx.font=`800 ${52*sc}px ${TH.f}`; ctx.letterSpacing=(-1*sc)+'px';
    ctx.textBaseline='middle';
    ctx.fillText(ys, pX, cardY+tH/2+3*sc);
    const yw=ctx.measureText(ys).width;

    // Unit
    ctx.fillStyle='rgba(255,255,255,.25)';
    ctx.font=`500 ${12*sc}px ${TH.f}`; ctx.letterSpacing='0px';
    ctx.fillText(S.unit, pX+yw+4*sc, cardY+tH/2+9*sc);
    ctx.restore();
  }

  /* â”€â”€ Shot type badge (top-right of info) â”€â”€ */
  if(S.showType){
    const col=TH.stCol[S.shotType]||'rgba(255,255,255,.86)';
    const lbl=TH.stLbl[S.shotType]||S.shotType;
    ctx.save();
    ctx.textAlign='right'; ctx.textBaseline='top';
    ctx.fillStyle=col;
    ctx.font=`700 ${11*sc}px ${TH.f}`; ctx.letterSpacing=(2*sc)+'px';
    ctx.fillText(lbl, iX+iW-14*sc, cardY+15*sc);
    ctx.restore();
  }

  /* â”€â”€ Result badge â”€â”€ */
  if(S.holeResult){
    const rl=TH.resLbl[S.holeResult]||S.holeResult.toUpperCase();
    const rc=TH.rCol[S.holeResult]||'#A8B8C4';
    const rgb=hexRgb(rc);
    ctx.save();
    ctx.font=`700 ${11*sc}px ${TH.f}`; ctx.letterSpacing=(2*sc)+'px';
    const rw=ctx.measureText(rl).width;
    const bpad=7*sc, rbH=20*sc;
    const by=cardY+(S.showType?36*sc:14*sc);
    const bx=iX+iW-14*sc-rw-bpad*2;
    rrect(ctx,bx,by,rw+bpad*2,rbH,4*sc);
    ctx.fillStyle=`rgba(${rgb},0.16)`; ctx.fill();
    ctx.strokeStyle=`rgba(${rgb},0.4)`; ctx.lineWidth=1*sc; ctx.stroke();
    ctx.fillStyle=rc; ctx.textAlign='left'; ctx.textBaseline='middle';
    ctx.fillText(rl,bx+bpad,by+rbH/2);
    ctx.restore();
  }

  /* â”€â”€ Shot pips (bottom strip) â”€â”€ */
  const pipMax=Math.max(S.par,S.shotIndex);
  const pW=24*sc, pH=18*sc, pG=4*sc;
  let sx=iX+12*sc+32*sc;
  const sy=cardY+tH+1*sc+(bH-pH)/2;

  ctx.save();
  ctx.textAlign='left'; ctx.textBaseline='middle';
  ctx.fillStyle='rgba(255,255,255,.2)';
  ctx.font=`600 ${7.5*sc}px ${TH.f}`; ctx.letterSpacing=(1.5*sc)+'px';
  ctx.fillText('SHOT', iX+12*sc, cardY+tH+bH/2);

  for(let i=1;i<=pipMax;i++){
    const iC=i===S.shotIndex, iD=i<S.shotIndex;
    rrect(ctx,sx,sy,pW,pH,2.5*sc);
    if(iC){
      ctx.fillStyle=TH.gold;
    } else if(iD){
      ctx.fillStyle='rgba(255,255,255,.15)';
    } else {
      ctx.fillStyle='rgba(255,255,255,.05)';
      ctx.strokeStyle='rgba(255,255,255,.09)'; ctx.lineWidth=1*sc; ctx.stroke();
    }
    ctx.fill();
    ctx.font=`700 ${9*sc}px ${TH.f}`; ctx.letterSpacing='0px';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle=iC?'#000':iD?'rgba(255,255,255,.45)':'rgba(255,255,255,.1)';
    ctx.fillText(String(i),sx+pW/2,sy+pH/2+.5*sc);
    sx+=pW+pG;
  }
  ctx.restore();
}

/* â”€â”€ Safe zones â”€â”€ */
function drawSafeZones(ctx,cW,cH){
  if(!S.safeOn) return;
  ctx.save();
  ctx.setLineDash([5,4]); ctx.lineWidth=1;
  const ax=cW*.05,ay=cH*.05;
  ctx.strokeStyle='rgba(255,200,0,.28)'; ctx.strokeRect(ax,ay,cW-ax*2,cH-ay*2);
  ctx.setLineDash([]);
  ctx.fillStyle='rgba(255,200,0,.4)'; ctx.font='9px system-ui'; ctx.letterSpacing='1px';
  ctx.textAlign='left'; ctx.textBaseline='top';
  ctx.fillText('ACTION SAFE',ax+4,ay+3);
  ctx.setLineDash([5,4]);
  const tx=cW*.1,ty=cH*.1;
  ctx.strokeStyle='rgba(255,140,0,.2)'; ctx.strokeRect(tx,ty,cW-tx*2,cH-ty*2);
  ctx.setLineDash([]);
  ctx.fillStyle='rgba(255,140,0,.35)';
  ctx.fillText('TITLE SAFE',tx+4,ty+3);
  ctx.restore();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREVIEW STAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const canvas=el('pcanvas');
const ctx2=canvas.getContext('2d');

function getCanvasSize(){
  const area=el('previewArea');
  const wW=area.clientWidth, wH=area.clientHeight;
  const ratio=ASP_RATIO[S.aspect]||(16/9);
  let cW,cH;
  if(wW/wH>ratio){ cH=wH; cW=Math.round(cH*ratio); }
  else            { cW=wW; cH=Math.round(cW/ratio); }
  return {cW:Math.max(cW,100), cH:Math.max(cH,60)};
}

// Overlay scale: reference = 1920px wide  (1080p)
// User ovScale multiplier applied on top
function ovScaleFor(cW){ return Math.max(.2, Math.min(3, (cW/1920)*(S.ovScale||1.0))); }

function ovPosFor(cW,cH,sc,preset,insetPx,cxN,cyN){
  const sp=S.showPlayer && S.playerName;
  const ovW=OVW*sc, ovH=totalOvH(sp)*sc;
  const i=insetPx*(cW/1920);
  if(preset==='custom'&&cxN!==null) return {x:cxN*cW,y:cyN*cH,ovW,ovH};
  switch(preset){
    case 'TR': return {x:cW-ovW-i,y:i,        ovW,ovH};
    case 'TL': return {x:i,       y:i,        ovW,ovH};
    case 'BL': return {x:i,       y:cH-ovH-i,ovW,ovH};
    case 'BR': return {x:cW-ovW-i,y:cH-ovH-i,ovW,ovH};
    case 'C':  return {x:(cW-ovW)/2,y:(cH-ovH)/2,ovW,ovH};
    default:   return {x:cW-ovW-i,y:i,        ovW,ovH};
  }
}

function render(){
  const {cW,cH}=getCanvasSize();
  const dpr=Math.min(window.devicePixelRatio||1, 2.5);

  canvas.width=cW*dpr; canvas.height=cH*dpr;
  canvas.style.width=cW+'px'; canvas.style.height=cH+'px';
  const cw=el('canvasWrap');
  cw.style.width=cW+'px'; cw.style.height=cH+'px';

  const ctx=ctx2;
  ctx.setTransform(dpr,0,0,dpr,0,0);

  // Stage background
  ctx.fillStyle='#07090f'; ctx.fillRect(0,0,cW,cH);

  // Aspect watermark
  ctx.fillStyle='rgba(255,255,255,.022)';
  ctx.font=`700 ${Math.round(cH*.034)}px system-ui`; ctx.letterSpacing='5px';
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText({169:'16:9',916:'9:16',11:'1:1'}[S.aspect]||'', cW/2,cH/2);

  // Ref image (preview only)
  if(refImg&&refVisible){
    ctx.save(); ctx.globalAlpha=refOpacity;
    const iW2=refImg.naturalWidth,iH2=refImg.naturalHeight;
    const scR=Math.max(cW/iW2,cH/iH2)*refScaleMod;
    ctx.drawImage(refImg,(cW-iW2*scR)/2+refOffX,(cH-iH2*scR)/2+refOffY,iW2*scR,iH2*scR);
    ctx.restore();
  }

  // Overlay
  const sc=ovScaleFor(cW);
  let {x:ox,y:oy,ovW,ovH}=ovPosFor(cW,cH,sc,S.position,S.inset,S.customX,S.customY);
  ox=Math.max(0,Math.min(cW-ovW,ox)); oy=Math.max(0,Math.min(cH-ovH,oy));
  drawOverlay(ctx,{scale:sc,ox,oy,forExport:false});

  // Safe zones
  drawSafeZones(ctx,cW,cH);

  syncUI();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT MODULE (same renderOverlay logic)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function doExport(){
  const resH=parseInt(el('resSel').value)||2160;
  const ratio=ASP_RATIO[S.aspect]||(16/9);
  const expW=Math.round(resH*ratio), expH=resH;

  const ec=document.createElement('canvas');
  ec.width=expW; ec.height=expH;
  const ectx=ec.getContext('2d');

  if(S.fmt==='black'){ ectx.fillStyle='#000'; ectx.fillRect(0,0,expW,expH); }
  // transparent = nothing drawn before overlay

  // Overlay at export resolution
  const sc=ovScaleFor(expW);
  let {x:ox,y:oy,ovW,ovH}=ovPosFor(expW,expH,sc,S.position,S.inset,S.customX,S.customY);
  ox=Math.max(0,Math.min(expW-ovW,ox)); oy=Math.max(0,Math.min(expH-ovH,oy));
  drawOverlay(ectx,{scale:sc,ox,oy,forExport:true});
  // Note: ref image NOT included in export (per spec)

  const ts=S.shotType.toLowerCase();
  const rs=S.holeResult?'_'+S.holeResult:'';
  const fn=`hole${pad(S.holeNumber)}_shot${pad(S.shotIndex)}_${ts}${rs}_${resH}p.png`;

  const a=document.createElement('a');
  a.download=fn; a.href=ec.toDataURL('image/png'); a.click();

  const fb=el('expFb');
  fb.textContent='âœ“ '+fn; fb.classList.add('on');
  const btn=el('btnExp'); btn.disabled=true;
  setTimeout(()=>{ fb.classList.remove('on'); btn.disabled=false; },3000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI SYNC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function syncUI(){
  el('inHole').value   = S.holeNumber;
  el('inYards').value  = S.yards;
  el('insetIn').value  = S.inset;
  el('inPlayer').value = S.playerName;
  el('inStrokes').value= S.strokes;
  el('unitTag').textContent  = S.unit;
  el('yardsLbl').textContent = 'è·ç¦» '+(S.unit==='M'?'Metres':'Yards')+' (To Pin)';

  // Par segment
  document.querySelectorAll('.seg-btn').forEach(b=>
    b.classList.toggle('on',parseInt(b.getAttribute('data-p'))===S.par));

  // Shot type
  document.querySelectorAll('.st-btn').forEach(b=>
    b.className='st-btn'+(b.getAttribute('data-st')===S.shotType?' on-'+S.shotType:''));

  // Result
  document.querySelectorAll('.res-btn').forEach(b=>{
    const r=b.getAttribute('data-r');
    b.className='res-btn'+(r===S.holeResult?' on-'+r:'');
  });

  // Checkboxes
  ['chkYards','chkType','chkPlayer','chkTotal'].forEach(id=>{
    const key=id.replace('chk','show').replace(/./,c=>c.toLowerCase());
    const key2='show'+id.slice(3);
    el(id).classList.toggle('on', S[key2]);
  });

  // Total mode row
  el('totalModeRow').style.display=S.showTotal?'flex':'none';
  el('tmGross').classList.toggle('on',S.totalMode==='gross');
  el('tmPar').classList.toggle('on',S.totalMode==='par');

  // Auto tag
  el('autoTag').style.opacity=S.manualType?'.28':'1';

  // Undo button
  el('btnUndoShot').disabled=!shotStack.length;

  // Pos buttons
  document.querySelectorAll('.pos-btn').forEach(b=>
    b.classList.toggle('on',b.getAttribute('data-pos')===S.position));

  // Aspect chips
  ['169','916','11'].forEach(a=>el('asp'+a).classList.toggle('on',a===S.aspect));

  // Unit chips
  el('unitYds').classList.toggle('on',S.unit==='YDS');
  el('unitM').classList.toggle('on',S.unit==='M');

  // Safe zone
  el('btnSafe').classList.toggle('on',S.safeOn);

  // Fmt
  el('fmtT').classList.toggle('on',S.fmt==='transparent');
  el('fmtB').classList.toggle('on',S.fmt==='black');

  // Scorecard strip
  renderScorecard();

  // Status bar
  const yd=S.unit==='M'?Math.round(S.yards*.9144)+'m':S.yards+'yd';
  el('sbText').textContent=
    `Hole ${S.holeNumber} Â· Par ${S.par} Â· Shot ${S.shotIndex} Â· ${TH.stLbl[S.shotType]||S.shotType} Â· ${yd}`+
    (S.holeResult?' Â· '+(TH.resLbl[S.holeResult]||S.holeResult):'');
}

function renderScorecard(){
  const strip=el('scStrip');
  strip.innerHTML='';
  const totals=roundTotals();

  for(let h=1;h<=18;h++){
    const rec=S.round.find(r=>r.holeNumber===h);
    const div=document.createElement('div');
    div.className='sc-hole';
    const lbl=document.createElement('div');
    lbl.className='sc-h-lbl'; lbl.textContent=h;
    const val=document.createElement('div');
    val.className='sc-h-val';
    if(rec){
      const d=(rec.strokes||rec.par)-rec.par;
      val.textContent=rec.strokes||rec.par;
      if(d<=-2) val.classList.add('eagle');
      else if(d===-1) val.classList.add('birdie');
      else if(d===0) val.classList.add('par');
      else if(d===1) val.classList.add('bogey');
      else if(d>=2) val.classList.add('double');
    } else if(h===S.holeNumber){
      val.textContent='â†’'; val.style.color='var(--gold)';
    } else {
      val.style.opacity='.2';
    }
    div.appendChild(lbl); div.appendChild(val);
    strip.appendChild(div);
  }

  // Totals
  if(S.round.length>0){
    el('totGross').textContent=totals.gross;
    const p=totals.par;
    const pStr=p===0?'E':p>0?'+'+p:String(p);
    el('totPar').textContent=pStr;
    el('totPar').className='sc-tot-val'+(p<0?' under':p>0?' over':'');
  } else {
    el('totGross').textContent='â€”';
    el('totPar').textContent='â€”';
    el('totPar').className='sc-tot-val';
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INTERACTION: drag overlay + pan ref + pinch zoom
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _ovDrag=false,_ovDX=0,_ovDY=0;
let _bgDrag=false,_bgX=0,_bgY=0,_bgOX=0,_bgOY=0;
let _pt1=null,_pt2=null,_rScStart=1;

function hitOv(mx,my){
  const {cW,cH}=getCanvasSize();
  const sc=ovScaleFor(cW);
  const {x,y,ovW,ovH}=ovPosFor(cW,cH,sc,S.position,S.inset,S.customX,S.customY);
  const cx=Math.max(0,Math.min(cW-ovW,x));
  const cy=Math.max(0,Math.min(cH-ovH,y));
  return {hit:mx>=cx&&mx<=cx+ovW&&my>=cy&&my<=cy+ovH,cx,cy,ovW,ovH,cW,cH};
}
function pxy(e){
  const r=canvas.getBoundingClientRect();
  const s=e.touches?e.touches[0]:e;
  return {x:s.clientX-r.left, y:s.clientY-r.top};
}

// Prevent canvas click from propagating to preview area
canvas.addEventListener('click',e=>e.stopPropagation());

// Tap empty preview area â†’ open file picker
el('previewArea').addEventListener('click',e=>{
  if(!refImg) el('refIn').click();
});

canvas.addEventListener('mousedown',onPD);
canvas.addEventListener('mousemove',onPM);
canvas.addEventListener('mouseup',onPU);
canvas.addEventListener('mouseleave',onPU);
canvas.addEventListener('touchstart',onTD,{passive:false});
canvas.addEventListener('touchmove',onTM,{passive:false});
canvas.addEventListener('touchend',onPU,{passive:false});

function onTD(e){
  if(e.touches.length===2){
    _pt1=e.touches[0]; _pt2=e.touches[1]; _rScStart=refScaleMod;
    e.preventDefault(); return;
  }
  onPD(e);
}
function onTM(e){
  if(e.touches.length===2&&_pt1){
    const d0=Math.hypot(_pt2.clientX-_pt1.clientX,_pt2.clientY-_pt1.clientY);
    const d1=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY);
    refScaleMod=Math.max(.3,Math.min(4,_rScStart*(d1/d0)));
    render(); e.preventDefault(); return;
  }
  onPM(e);
}
function onPD(e){
  const {x,y}=pxy(e);
  const {hit,cx,cy,ovW,ovH,cW,cH}=hitOv(x,y);
  if(hit){
    _ovDrag=true; _ovDX=x-cx; _ovDY=y-cy;
    canvas.classList.add('ov-drag');
    e.preventDefault&&e.preventDefault(); e.stopPropagation&&e.stopPropagation();
  } else if(refImg&&refVisible){
    _bgDrag=true; _bgX=x; _bgY=y; _bgOX=refOffX; _bgOY=refOffY;
    canvas.classList.add('bg-drag');
    e.preventDefault&&e.preventDefault(); e.stopPropagation&&e.stopPropagation();
  } else {
    e.stopPropagation&&e.stopPropagation();
    el('refIn').click();
  }
}
function onPM(e){
  if(!_ovDrag&&!_bgDrag){
    const {x,y}=pxy(e);
    canvas.classList.toggle('ov-hover',hitOv(x,y).hit);
    return;
  }
  const {x,y}=pxy(e);
  if(_ovDrag){
    const {cW,cH,ovW,ovH}=hitOv(0,0);
    S.position='custom';
    S.customX=Math.max(0,Math.min(1-ovW/cW,(x-_ovDX)/cW));
    S.customY=Math.max(0,Math.min(1-ovH/cH,(y-_ovDY)/cH));
    document.querySelectorAll('.pos-btn').forEach(b=>b.classList.remove('on'));
    render(); e.preventDefault&&e.preventDefault();
  } else if(_bgDrag){
    refOffX=_bgOX+(x-_bgX); refOffY=_bgOY+(y-_bgY);
    render(); e.preventDefault&&e.preventDefault();
  }
}
function onPU(){
  if(_ovDrag){ _ovDrag=false; queueSave(); }
  _bgDrag=false; _pt1=null;
  canvas.classList.remove('ov-drag','bg-drag','ov-hover');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT') return;
  const k=e.key.toLowerCase();
  if((k==='z'&&(e.metaKey||e.ctrlKey))||k==='u'){ e.preventDefault(); undoShot(); }
  else if(k==='n'||k==='arrowright') nextShot();
  else if(k==='h') newHole();
  else if(k==='b') setRes('birdie');
  else if(k==='p') setRes('par');
  else if(k==='g') setRes('bogey');
  else if(k==='enter') doExport();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
loadState();
// Restore overlay scale UI
(()=>{
  const s=S.ovScale||1.0;
  const id=s<=.85?'scSm':s>=1.15?'scLg':'scMd';
  ['scSm','scMd','scLg'].forEach(i=>el(i).classList.toggle('on',i===id));
})();
render();
window.addEventListener('resize',()=>render());
</script>
</body>
</html>
